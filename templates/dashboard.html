<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Dashboard</title>
   <link rel="stylesheet" href="/static/css/dashboard.css">
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>

  <!-- Flash Messages -->
  <div class="flash-container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Dashboard</h2>
        <a href="#" id="product-management">Product Management</a><hr>
        <a href="#" id="orders">Orders</a><hr>
        <a href="#" id="alerts-notifications">Alerts and Notifications</a><hr>
        <a href="/export/inventory-csv">Export CSV</a>
    </div>

    <!-- Main Content Area -->
    <div id="content">
      <h1 style="text-align: center;">CLOTHING STORE INVENTORY</h1>
      <div id="dashboard-data">
        <!-- This will be filled dynamically -->
      </div>
    </div>
  </div>
    
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Sidebar Navigation
        document.getElementById('product-management').addEventListener('click', () => {
            window.location.href = "/viewItems";
        });

        document.getElementById('orders').addEventListener('click', () => {
            document.getElementById('dashboard-data').innerHTML = `<h2>Orders</h2><p>Order module coming soon!</p>`;
        });

        document.getElementById('alerts-notifications').addEventListener('click', () => {
    window.location.href = '/lowStockAlerts';
});


        // Load Dashboard on Load
        loadInventoryOverview();
    });

    function loadInventoryOverview() {
        fetch('/api/inventory-data')
            .then(response => response.json())
            .then(mainData => {
                fetch('/api/products-per-category')
                    .then(res1 => res1.json())
                    .then(categoryData => {
                        fetch('/api/stock-status')
                            .then(res2 => res2.json())
                            .then(stockData => {
                                const html = `
                                    <h2 style="text-align: center;">Inventory Overview</h2>
                                    <div class="top-row">
                                                    <div class="dashboard-box">
                                                    <p class="dashboard-text">Total Inventory Value</p>
                                                    <p class="dashboard-value">â‚¹${mainData.TotalValue}</p>
                                                    </div>
                                                    <div class="dashboard-box">
                                                    <p class="dashboard-text">Total Items</p>
                                                    <p class="dashboard-value">${mainData.TotalItems}</p>
                                                    </div>
                                                    <div class="dashboard-box chart-box">
                                                    <canvas id="pieChart"></canvas>
                                                    </div>
                                                </div>
                                                    
                                        <div class="bottom-row">
                                            <canvas id="barChart"></canvas>
                                        </div>
                                    
                                `;
                                document.getElementById('dashboard-data').innerHTML = html;
                                                                                             

                                new Chart(document.getElementById('barChart').getContext('2d'), {
                                    type: 'bar',
                                    data: {
                                        labels: categoryData.labels,
                                        datasets: [{
                                            label: 'Products per Category',
                                            data: categoryData.values,
                                            backgroundColor: '#007bff'
                                        }]
                                    },options: {
                                                            scales: {
                                                            x: {
                                                                grid: {
                                                                display: false   
                                                                }
                                                            },
                                                            y: {
                                                                grid: {
                                                                display: false   
                                                                },
                                                                ticks: {
                                                                beginAtZero: true
                                                                }
                                                            }
                                                            }
                                                        }
                                     
                                      });





                                new Chart(document.getElementById('pieChart').getContext('2d'), {
                                    type: 'pie',
                                    data: {
                                        labels: stockData.labels,
                                        datasets: [{
                                            data: stockData.values,
                                            backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                                        }]
                                    },options: {
                                                responsive: true,
                                                maintainAspectRatio: false
                                            } 
                                                        
                                });
                            });
                    });
            });
    }
  </script>
<script>
  // Auto-dismiss flash messages after 4 seconds
  setTimeout(function () {
    const flashMessages = document.querySelectorAll('.flash-message');
    flashMessages.forEach(msg => {
      msg.style.opacity = '0';
      setTimeout(() => {
        msg.remove();
      }, 500); // Wait for fade-out
    });
  }, 4000); // Visible for 4 seconds
</script>

</body>
</html>
